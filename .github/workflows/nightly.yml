name: Nightly E2E

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Unit tests
        run: nix build .#checks.x86_64-linux.unit-tests

  daily-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Plain integration tests
        run: nix build .#checks.x86_64-linux.plain-integration-tests -o result-plain

      - name: HAT integration tests
        run: nix build .#checks.x86_64-linux.hat-integration-tests -o result-hat

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-results
          path: |
            result-plain/reports/
            result-hat/reports/
          retention-days: 3

  daily-benchmarks:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Cache Llama 3.2 1B Model
        id: cache-llama
        uses: actions/cache@v4
        with:
          path: Llama-3.2-1B-Instruct-f16.gguf
          key: llama-3.2-1b-instruct-f16-gguf

      - name: Download Llama 3.2 1B Instruct FP16
        if: steps.cache-llama.outputs.cache-hit != 'true'
        run: ./scripts/download_llama_fp16.sh

      - name: Run daily benchmarks
        env:
          CI: "true"
          LLAMA_FP16_PATH: ${{ github.workspace }}/Llama-3.2-1B-Instruct-f16.gguf
        run: |
          nix develop -c bash -c '
            set -euo pipefail
            export GRADLE_OPTS="${GRADLE_OPTS:-} -Dorg.gradle.java.installations.paths=$JAVA_HOME"
            export PATH="$JAVA_HOME/bin:$PATH"
            chmod +x gradlew
            ./gradlew benchmarkKernelAll --console=plain
          '

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-benchmarks
          path: |
            build/reports/tests/benchmarkKernelGEMV/
            build/test-results/benchmarkKernelGEMV/
            build/reports/tests/benchmarkKernelRMSNorm/
            build/test-results/benchmarkKernelRMSNorm/
            build/reports/tests/benchmarkKernelRoPE/
            build/test-results/benchmarkKernelRoPE/
            build/reports/tests/benchmarkKernelSiLU/
            build/test-results/benchmarkKernelSiLU/
            build/reports/tests/benchmarkKernelSoftmax/
            build/test-results/benchmarkKernelSoftmax/
            build/reports/tests/benchmarkKernelAttention/
            build/test-results/benchmarkKernelAttention/
            build/benchmark-results/results.tsv
          retention-days: 3
