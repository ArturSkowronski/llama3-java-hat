name: Weekly Full Matrix

on:
  schedule:
    - cron: '0 3 * * 0'  # Sunday 3 AM UTC
  workflow_dispatch:

jobs:
  baseline-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Plain Java integration tests
        run: nix build .#checks.x86_64-linux.plain-integration-tests -o result-baseline

      - name: Upload baseline results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-results-baseline
          path: result-baseline/reports/
          retention-days: 7

  benchmarks:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Cache Llama 3.2 1B Model
        id: cache-llama
        uses: actions/cache@v4
        with:
          path: Llama-3.2-1B-Instruct-f16.gguf
          key: llama-3.2-1b-instruct-f16-gguf

      - name: Download Llama 3.2 1B Instruct FP16
        if: steps.cache-llama.outputs.cache-hit != 'true'
        run: ./scripts/download_llama_fp16.sh

      - name: Run weekly benchmarks
        env:
          CI: "true"
          LLAMA_FP16_PATH: ${{ github.workspace }}/Llama-3.2-1B-Instruct-f16.gguf
        run: |
          nix develop -c bash -c '
            set -euo pipefail
            export GRADLE_OPTS="${GRADLE_OPTS:-} -Dorg.gradle.java.installations.paths=$JAVA_HOME"
            export PATH="$JAVA_HOME/bin:$PATH"
            chmod +x gradlew
            ./gradlew benchmarkAll --console=plain
          '

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-results-benchmarks
          path: |
            build/reports/tests/benchmarkKernelGEMV/
            build/test-results/benchmarkKernelGEMV/
            build/reports/tests/benchmarkKernelRMSNorm/
            build/test-results/benchmarkKernelRMSNorm/
            build/reports/tests/benchmarkKernelRoPE/
            build/test-results/benchmarkKernelRoPE/
            build/reports/tests/benchmarkKernelSiLU/
            build/test-results/benchmarkKernelSiLU/
            build/reports/tests/benchmarkKernelSoftmax/
            build/test-results/benchmarkKernelSoftmax/
            build/reports/tests/benchmarkKernelAttention/
            build/test-results/benchmarkKernelAttention/
            build/reports/tests/benchmark/
            build/test-results/benchmark/
            build/reports/tests/benchmarkMicroGEMV/
            build/test-results/benchmarkMicroGEMV/
            build/reports/tests/benchmarkMicroRMSNorm/
            build/test-results/benchmarkMicroRMSNorm/
            build/reports/tests/benchmarkMicroRoPE/
            build/test-results/benchmarkMicroRoPE/
            build/reports/tests/benchmarkMicroSiLU/
            build/test-results/benchmarkMicroSiLU/
            build/reports/tests/benchmarkMicroSoftmax/
            build/test-results/benchmarkMicroSoftmax/
            build/reports/tests/benchmarkMicroAttention/
            build/test-results/benchmarkMicroAttention/
            build/benchmark-results/results.tsv
          retention-days: 7

  regression-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Cache Llama 3.2 1B Model
        id: cache-llama
        uses: actions/cache@v4
        with:
          path: Llama-3.2-1B-Instruct-f16.gguf
          key: llama-3.2-1b-instruct-f16-gguf

      - name: Download Llama 3.2 1B Instruct FP16
        if: steps.cache-llama.outputs.cache-hit != 'true'
        run: ./scripts/download_llama_fp16.sh

      - name: Run regression tests
        env:
          CI: "true"
          LLAMA_FP16_PATH: ${{ github.workspace }}/Llama-3.2-1B-Instruct-f16.gguf
        run: |
          nix develop -c bash -c '
            set -euo pipefail
            export GRADLE_OPTS="${GRADLE_OPTS:-} -Dorg.gradle.java.installations.paths=$JAVA_HOME"
            export PATH="$JAVA_HOME/bin:$PATH"
            chmod +x gradlew
            ./gradlew regressionTest --console=plain
          '

      - name: Upload regression results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-results-regression
          path: |
            build/reports/tests/regressionTest/
            build/test-results/regressionTest/
          retention-days: 7

  all-hat-test:
    needs: [baseline-test, benchmarks, regression-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: HAT integration tests
        run: nix build .#checks.x86_64-linux.hat-integration-tests -o result-hat

      - name: Upload all-HAT results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-results-all-hat
          path: result-hat/reports/
          retention-days: 7
