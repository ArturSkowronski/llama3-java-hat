name: E2E Integration Tests (FP16 + HAT)

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Which tests to run'
        required: true
        default: 'all-hat'
        type: choice
        options:
          - baseline-only
          - all-hat
          - full-matrix

concurrency:
  group: chat-test-${{ github.head_ref || github.ref }}
  cancel-in-progress: false

jobs:
  # Job 1: Plain Java baseline test (pure Nix check â€” model fetched by Nix)
  baseline-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Plain Java integration tests
        run: nix build .#checks.x86_64-linux.plain-integration-tests -o result-baseline

      - name: Upload baseline results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-baseline
          path: result-baseline/reports/
          retention-days: 7

  # Job 2: All-HAT test (all 6 kernels enabled simultaneously)
  # Only on manual dispatch with all-hat or full-matrix scope (PRs run baseline only)
  all-hat-test:
    needs: baseline-test
    if: github.event_name == 'workflow_dispatch' && (inputs.test_scope == 'all-hat' || inputs.test_scope == 'full-matrix')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: HAT integration tests
        run: nix build .#checks.x86_64-linux.hat-integration-tests -o result-all-hat

      - name: Upload all-HAT results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-all-hat
          path: result-all-hat/reports/
          retention-days: 7

  # Job 3: Individual HAT kernel matrix (manual dispatch with full-matrix only)
  individual-hat-tests:
    needs: baseline-test
    if: github.event_name == 'workflow_dispatch' && inputs.test_scope == 'full-matrix'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        kernel: [SiLU, RoPE, Softmax, RMSNorm, Attention, GEMV]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Cache Llama 3.2 1B Model
        id: cache-llama
        uses: actions/cache@v4
        with:
          path: Llama-3.2-1B-Instruct-f16.gguf
          key: llama-3.2-1b-instruct-f16-gguf

      - name: Download Llama 3.2 1B Instruct FP16
        if: steps.cache-llama.outputs.cache-hit != 'true'
        run: ./scripts/download_llama_fp16.sh

      - name: Run ${{ matrix.kernel }} HAT regression test
        timeout-minutes: 30
        env:
          CI: "true"
          LLAMA_FP16_PATH: ${{ github.workspace }}/Llama-3.2-1B-Instruct-f16.gguf
        run: |
          nix develop -c bash -c '
            set -euo pipefail
            export GRADLE_OPTS="${GRADLE_OPTS:-} -Dorg.gradle.java.installations.paths=$JAVA_HOME"
            export PATH="$JAVA_HOME/bin:$PATH"
            chmod +x gradlew
            ./gradlew regressionTest --tests "com.arturskowronski.llama3babylon.hat.regression.chat.ChatIntegrationTestWith${{ matrix.kernel }}HAT" --console=plain
          '

      - name: Upload ${{ matrix.kernel }} results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.kernel }}-hat
          path: |
            build/reports/tests/regressionTest/
            build/test-results/regressionTest/
          retention-days: 7
